name: Continuous Integration

env:
  # Use docker.io for Docker Hub if empty
  REGISTRY: ghcr.io
  # github.repository as <account>/<repo>
  IMAGE_NAME: ${{ github.repository }}

on:
  push:
    branches:
      - main
      - dev
    tags:
      - production*
      - staging*
    paths-ignore:
      - "k8s/**"

jobs:
  version:
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/production') || startsWith(github.ref, 'refs/tags/staging')
    runs-on: ubuntu-latest

    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üõ† Enable pnpm
        uses: actions/setup-node@v4
        with:
          node-version: 20
          check-latest: true
          cache: "pnpm"

      - name: üîß Activate pnpm
        run: corepack prepare pnpm@10.17.0 --activate

      - name: üé´ Update patch version
        run: |
          git fetch
          git checkout main
          git pull origin main
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          if [[ $GITHUB_REF == refs/tags/production* ]]; then
            pnpm version major
          elif [[ $GITHUB_REF == refs/tags/staging* ]]; then
            pnpm version minor
          else
            pnpm version patch
          fi
          git fetch --all
          git push origin main

  prod:
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/production') || startsWith(github.ref, 'refs/tags/staging')
    runs-on: ubuntu-latest
    needs: version

    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üõ† Enable pnpm
        uses: actions/setup-node@v4
        with:
          node-version: 20
          check-latest: true
          cache: "pnpm"

      - name: üîß Activate pnpm
        run: corepack prepare pnpm@10.17.0 --activate

      - id: imagename
        uses: ASzc/change-string-case-action@v2
        with:
          string: ${{ github.repository }}

      - run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          if [[ $GITHUB_REF == refs/tags/production* ]]; then
            pnpm version major
          elif [[ $GITHUB_REF == refs/tags/staging* ]]; then
            pnpm version minor
          else
            pnpm version patch
          fi

      - name: üìù Get Current Version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@main

      - name: üîê Login to Docker Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üîß Build and push Simulator
        uses: docker/build-push-action@v4
        with:
          context: .
          file: packages/simulator/Dockerfile
          push: true
          build-args: |
            TELGE_API_BASE_URL=${{ secrets.TELGE_API_BASE_URL }}
            TELGE_API_USERNAME=${{ secrets.TELGE_API_USERNAME }}
            TELGE_API_PASSWORD=${{ secrets.TELGE_API_PASSWORD }}
          tags: |
            ${{ env.REGISTRY }}/${{ steps.imagename.outputs.lowercase  }}-simulator:${{ steps.package-version.outputs.current-version}}
      - name: üîß Build and push Visualisation
        uses: docker/build-push-action@v4
        with:
          context: .
          file: packages/visualisation/Dockerfile
          push: true
          build-args: |
            VITE_MAPBOX_ACCESS_TOKEN=${{ secrets.VITE_MAPBOX_ACCESS_TOKEN }}
            VITE_SIMULATOR_URL=${{ secrets.VITE_SIMULATOR_URL }}
            VITE_AZURE_AD_CLIENT_ID=${{ secrets.VITE_AZURE_AD_CLIENT_ID }}
            VITE_AZURE_AD_TENANT_ID=${{ secrets.VITE_AZURE_AD_TENANT_ID }}
            VITE_AZURE_AD_REDIRECT_URI=${{ secrets.VITE_AZURE_AD_REDIRECT_URI }}
          tags: |
            ${{ env.REGISTRY }}/${{ steps.imagename.outputs.lowercase  }}-visualisation:${{ steps.package-version.outputs.current-version}}
      - name: üîß Build and push SampleAdresses
        uses: docker/build-push-action@v4
        with:
          context: .
          file: packages/sampleAddresses/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.imagename.outputs.lowercase  }}-sample:${{ steps.package-version.outputs.current-version}}

  dev:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest

    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v3

      - id: imagename
        uses: ASzc/change-string-case-action@v2
        with:
          string: ${{ github.repository }}

      - name: üîé Compute short SHA and timestamp
        id: meta
        run: |
          echo "sha_short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: üîê Login to Docker Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üîß Build and push Simulator (dev)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: packages/simulator/Dockerfile
          push: true
          build-args: |
            TELGE_API_BASE_URL=${{ secrets.TELGE_API_BASE_URL }}
            TELGE_API_USERNAME=${{ secrets.TELGE_API_USERNAME }}
            TELGE_API_PASSWORD=${{ secrets.TELGE_API_PASSWORD }}
          tags: |
            ${{ env.REGISTRY }}/${{ steps.imagename.outputs.lowercase  }}-simulator:dev
            ${{ env.REGISTRY }}/${{ steps.imagename.outputs.lowercase  }}-simulator:dev-${{ steps.meta.outputs.timestamp }}-${{ steps.meta.outputs.sha_short }}
      - name: üîß Build and push Visualisation (dev)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: packages/visualisation/Dockerfile
          push: true
          build-args: |
            VITE_MAPBOX_ACCESS_TOKEN=${{ secrets.VITE_MAPBOX_ACCESS_TOKEN }}
            VITE_SIMULATOR_URL=${{ secrets.VITE_SIMULATOR_URL_DEV }}
            VITE_AZURE_AD_CLIENT_ID=${{ secrets.VITE_AZURE_AD_CLIENT_ID }}
            VITE_AZURE_AD_TENANT_ID=${{ secrets.VITE_AZURE_AD_TENANT_ID }}
            VITE_AZURE_AD_REDIRECT_URI=${{ secrets.VITE_AZURE_AD_REDIRECT_URI_DEV }}
          tags: |
            ${{ env.REGISTRY }}/${{ steps.imagename.outputs.lowercase  }}-visualisation:dev
            ${{ env.REGISTRY }}/${{ steps.imagename.outputs.lowercase  }}-visualisation:dev-${{ steps.meta.outputs.timestamp }}-${{ steps.meta.outputs.sha_short }}
